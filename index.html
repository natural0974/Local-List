<!-- index.html (Excel-like layout) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Local List (Sheet View)</title>
  <link rel="stylesheet" href="local.css" />
</head>
<body>
  <!--
    Put these in your GitHub Pages repo root:
      - index.html
      - styles.css
      - local_list.csv

    This layout intentionally looks/feels like an Excel sheet:
      - faux ribbon
      - name box + formula bar
      - column letters + row numbers
      - grid lines + sticky headers
  -->

  <header class="excel-top">
    <div class="ribbon">
      <div class="ribbon-left">
        <span class="app-dot"></span>
        <span class="title">Local List</span>
        <span class="badge">Read-only</span>
      </div>
      <div class="ribbon-tabs">
        <span class="tab active">Home</span>
        <span class="tab">Data</span>
        <span class="tab">View</span>
        <span class="tab">Help</span>
      </div>
      <div class="ribbon-right">
        <span id="status" class="status">Loading local_list.csv…</span>
      </div>
    </div>

    <div class="formula-bar">
      <input class="name-box" id="nameBox" value="A1" aria-label="Name box" />
      <div class="fx">fx</div>
      <input class="formula" id="formulaInput" placeholder="Select a cell to view its contents…" aria-label="Formula bar" />
      <a class="download" id="downloadCsv" href="local_list.csv" download>Download CSV</a>
    </div>
  </header>

  <main class="sheet-wrap">
    <div class="sheet" role="region" aria-label="Sheet grid">
      <div class="corner" aria-hidden="true"></div>
      <div class="col-headers" id="colHeaders" aria-hidden="true"></div>
      <div class="row-headers" id="rowHeaders" aria-hidden="true"></div>

      <div class="grid" id="grid">
        <table id="table" aria-label="Local items (grid)">
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="tabs">
      <div class="sheet-tab active">Local List</div>
      <div class="sheet-tab">Notes</div>
      <div class="sheet-tab plus">+</div>
      <div class="spacer"></div>
      <div class="updated" id="updatedText">—</div>
    </div>

    <div class="error" id="error" role="alert"></div>
  </main>

  <script>
    const CSV_PATH = "local_list.csv";

    let selectedCell = null;

    function parseCSV(text) {
      // Robust-ish CSV parser (supports quotes/newlines)
      const rows = [];
      let i = 0, field = "", row = [], inQuotes = false;

      while (i < text.length) {
        const c = text[i];

        if (inQuotes) {
          if (c === '"') {
            const next = text[i + 1];
            if (next === '"') { field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          } else {
            field += c; i++; continue;
          }
        } else {
          if (c === '"') { inQuotes = true; i++; continue; }
          if (c === ",") { row.push(field); field = ""; i++; continue; }
          if (c === "\r") { i++; continue; }
          if (c === "\n") { row.push(field); rows.push(row); row = []; field = ""; i++; continue; }
          field += c; i++; continue;
        }
      }
      row.push(field);
      rows.push(row);

      while (rows.length && rows[rows.length - 1].every(x => String(x).trim() === "")) rows.pop();
      return rows;
    }

    function numToColLetters(n) {
      // 1 -> A, 26 -> Z, 27 -> AA
      let s = "";
      while (n > 0) {
        const r = (n - 1) % 26;
        s = String.fromCharCode(65 + r) + s;
        n = Math.floor((n - 1) / 26);
      }
      return s;
    }

    function setStatus(msg) {
      document.getElementById("status").textContent = msg || "";
    }

    function setError(msg) {
      document.getElementById("error").textContent = msg || "";
    }

    function setSelectedCell(td) {
      if (selectedCell) selectedCell.classList.remove("selected");
      selectedCell = td;
      selectedCell.classList.add("selected");

      const r = Number(td.dataset.r); // 1-based row (includes header row)
      const c = Number(td.dataset.c); // 1-based col
      const addr = `${numToColLetters(c)}${r}`;

      document.getElementById("nameBox").value = addr;
      document.getElementById("formulaInput").value = td.textContent ?? "";
    }

    function buildHeaders(colCount, rowCount) {
      // Column letters
      const colHeaders = document.getElementById("colHeaders");
      colHeaders.innerHTML = "";
      for (let c = 1; c <= colCount; c++) {
        const div = document.createElement("div");
        div.className = "col-h";
        div.textContent = numToColLetters(c);
        colHeaders.appendChild(div);
      }

      // Row numbers (include header row as row 1)
      const rowHeaders = document.getElementById("rowHeaders");
      rowHeaders.innerHTML = "";
      for (let r = 1; r <= rowCount; r++) {
        const div = document.createElement("div");
        div.className = "row-h";
        div.textContent = String(r);
        rowHeaders.appendChild(div);
      }

      // Set CSS variable for column count so header/grid align
      document.documentElement.style.setProperty("--colCount", colCount);
    }

    function renderGrid(rows) {
      // rows: array of arrays, includes header row at rows[0]
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      const colCount = Math.max(...rows.map(r => r.length));
      const rowCount = rows.length;

      buildHeaders(colCount, rowCount);

      for (let r = 0; r < rowCount; r++) {
        const tr = document.createElement("tr");
        tr.className = r === 0 ? "header-row" : "";

        for (let c = 0; c < colCount; c++) {
          const td = document.createElement("td");
          td.className = "cell";
          td.tabIndex = 0;

          const value = rows[r][c] ?? "";
          td.textContent = value;

          // dataset uses 1-based indices like Excel
          td.dataset.r = String(r + 1);
          td.dataset.c = String(c + 1);

          td.addEventListener("click", () => setSelectedCell(td));
          td.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              setSelectedCell(td);
            }
            // Basic arrow navigation
            if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) {
              e.preventDefault();
              const rr = Number(td.dataset.r);
              const cc = Number(td.dataset.c);
              let nr = rr, nc = cc;
              if (e.key === "ArrowUp") nr = Math.max(1, rr - 1);
              if (e.key === "ArrowDown") nr = Math.min(rowCount, rr + 1);
              if (e.key === "ArrowLeft") nc = Math.max(1, cc - 1);
              if (e.key === "ArrowRight") nc = Math.min(colCount, cc + 1);
              const next = document.querySelector(`td.cell[data-r="${nr}"][data-c="${nc}"]`);
              if (next) { next.focus(); setSelectedCell(next); }
            }
          });

          tr.appendChild(td);
        }

        tbody.appendChild(tr);
      }

      // Default select A1
      const first = document.querySelector('td.cell[data-r="1"][data-c="1"]');
      if (first) setSelectedCell(first);

      document.getElementById("updatedText").textContent = "Loaded: " + new Date().toLocaleString();
    }

    async function load() {
      setError("");
      setStatus("Loading local_list.csv…");

      try {
        const res = await fetch(CSV_PATH, { cache: "no-store" });
        if (!res.ok) throw new Error(`Could not load ${CSV_PATH} (HTTP ${res.status}).`);
        const text = await res.text();

        const parsed = parseCSV(text);
        if (!parsed.length) throw new Error("CSV appears empty.");

        // Keep as-is: header row + all data rows
        renderGrid(parsed);

        setStatus(`Loaded ${parsed.length - 1} row(s). Click cells to view in formula bar.`);
      } catch (e) {
        setStatus("");
        setError("Error: " + e.message + " — Make sure local_list.csv is in the same folder as index.html.");
      }
    }

    load();
  </script>
</body>
</html>

